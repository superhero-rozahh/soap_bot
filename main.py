from flask import Flask, request
from twilio.twiml.messaging_response import MessagingResponse
from dotenv import load_dotenv
import psycopg2
import os
import datetime

load_dotenv()

app = Flask(__name__)

# PostgreSQL connection
conn = psycopg2.connect(os.getenv("DATABASE_URL"))
cursor = conn.cursor()

# In-memory user session state
user_state = {}

@app.route("/", methods=["GET"])
def health():
    return "‚úÖ App is running!"

@app.route("/whatsapp", methods=["POST"])
def whatsapp():
    from_number = request.form.get("From")
    user_msg = request.form.get("Body").strip()

    print(f"[{datetime.datetime.now()}] From: {from_number}, Msg: {user_msg}")

    state = user_state.get(from_number, {"step": "–º–µ–Ω—é"})
    print(f"[{datetime.datetime.now()}] State Step: {state.get('step')}")

    resp = MessagingResponse()
    msg = resp.message()

    # Reset command
    if user_msg.lower() in ("–ø—Ä–∏–≤–µ—Ç", "–º–µ–Ω—é", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ"):
        state = {"step": "–º–µ–Ω—é"}
        msg.body(
            "üëã –ü—Ä–∏–≤–µ—Ç! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à WhatsApp-–º–∞–≥–∞–∑–∏–Ω –º—ã–ª–∞-–ø–µ–Ω–∫–∏!\n\n"
            "üåø –ù–µ–∂–Ω–∞—è –ø–µ–Ω–∞, –Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π —Å–æ—Å—Ç–∞–≤ –∏ —É–¥–æ–±–Ω—ã–π —Ñ–ª–∞–∫–æ–Ω ‚Äî –≤—Å—ë, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∑–∞–±–æ—Ç—ã –æ —Å–µ–±–µ.\n\n"
            "–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?\n\n"
            "1Ô∏è‚É£ –ó–∞–∫–∞–∑–∞—Ç—å –º—ã–ª–æ\n"
            "2Ô∏è‚É£ –£–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ\n\n"
            "–í–≤–µ–¥–∏—Ç–µ 1 –∏–ª–∏ 2:"
        )
        user_state[from_number] = state
        return str(resp)

    if state["step"] == "–º–µ–Ω—é":
        if user_msg == "1":
            state["step"] = "ask_quantity"
            msg.body("–û—Ç–ª–∏—á–Ω–æ! üßº –°–∫–æ–ª—å–∫–æ —à—Ç—É–∫ –º—ã–ª–∞ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫–∞–∑–∞—Ç—å?")
    elif user_msg == "2":
        msg.body(
            "üß¥ *–û –ø—Ä–æ–¥—É–∫—Ç–µ*\n"
            "‚Ä¢ –≠—Ç–æ –º—ã–ª–æ-–ø–µ–Ω–∫–∞ –¥–ª—è –∏–Ω—Ç–∏–º–Ω–æ–≥–æ —É—Ö–æ–¥–∞, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–∞—è –¥–ª—è –¥–µ–ª–∏–∫–∞—Ç–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –∏–Ω—Ç–∏–º–Ω—ã—Ö –∑–æ–Ω.\n"
            "‚Ä¢ –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–∂–∏ –∏ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏—è.\n"
            "‚Ä¢ –ú—è–≥–∫–∞—è –Ω–µ–∂–Ω–∞—è –ø–µ–Ω–∞, –∫–æ—Ç–æ—Ä–∞—è –Ω–µ –ø–µ—Ä–µ—Å—É—à–∏–≤–∞–µ—Ç –∫–æ–∂—É.\n"
            "‚Ä¢ –ë–µ–∑ —Å–ø–∏—Ä—Ç–∞ –∏ –æ—Ç–¥—É—à–µ–∫ ‚Äì –≥–∏–ø–æ–∞–ª–ª–µ—Ä–≥–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞.\n\n"
        
            "*–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞*\n"
            "‚Ä¢ –ì–∏–ø–æ–∞–ª–ª–µ—Ä–≥–µ–Ω–Ω–æ—Å—Ç—å ‚Äì –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.\n"
            "‚Ä¢ –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ‚Äì —É–¥–æ–±–Ω–æ –±—Ä–∞—Ç—å —Å —Å–æ–±–æ–π.\n"
            "‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –±–∞–ª–∞–Ω—Å –∫–æ–∂–∏.\n\n"
        
            "*–°–æ—Å—Ç–∞–≤:*\n"
            "–í–æ–¥–∞, –¢–µ–∞-–õ–∞—É—Ä–∏–ª —Å—É–ª—å—Ñ–∞—Ç, –ú–µ—Ç–∏–ª—Ö–ª–æ—Ä–æ–∏–∑–æ—Ç–∏–∞–∑–æ–ª–∏–Ω–æ–Ω, –ú–µ—Ç–∏–ª–∏–∑–æ—Ç–∏–∞–∑–æ–ª–∏–Ω–æ–Ω,\n"
            "–•–ª–æ—Ä–∏–¥ –º–∞–≥–Ω–∏—è, –ù–∏—Ç—Ä–∞—Ç –º–∞–≥–Ω–∏—è, –ì–ª–∏—Ü–µ—Ä–∏–Ω, –ö–æ–∫–∞–º–∏–¥–æ–ø—Ä–æ–ø–∏–ª –±–µ—Ç–∞–∏–Ω, –•–ª–æ—Ä–∏–¥ –Ω–∞—Ç—Ä–∏—è,\n"
            "–ü—Ä–æ–ø–∏–ª–µ–Ω–≥–ª–∏–∫–æ–ª—å, –õ–∞—É—Ä–∏–ª —Å—É–ª—å—Ñ–∞—Ç –Ω–∞—Ç—Ä–∏—è, –°—É–ª—å—Ñ–∞—Ç –Ω–∞—Ç—Ä–∏—è, –°–ø–∏—Ä—Ç—ã C12-16,\n"
            "–õ–∞—É—Ä–æ–∏–ª—Å–∞—Ä–∫–æ–∑–∏–Ω–∞—Ç –Ω–∞—Ç—Ä–∏—è, –§–µ–Ω–æ–∫—Å–∏—ç—Ç–∞–Ω–æ–ª, –ë–µ–Ω–∑–æ–∞—Ç –Ω–∞—Ç—Ä–∏—è –∏ –¥—Ä.\n\n"
        
            "*–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:*\n"
            "–î–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –≥–∏–≥–∏–µ–Ω—ã –∏–Ω—Ç–∏–º–Ω–æ–π –∑–æ–Ω—ã. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –∫–æ–∂–∏.\n\n"
        
            "*–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*\n"
            "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Ç—Ä–æ–º –∏ –≤–µ—á–µ—Ä–æ–º –≤–æ –≤—Ä–µ–º—è –¥—É—à–∞.\n\n"
        
            "*–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:*\n"
            "1. –í—Å—Ç—Ä—è—Ö–Ω–∏—Ç–µ –±—É—Ç—ã–ª–æ—á–∫—É.\n"
            "2. –ù–∞–Ω–µ—Å–∏—Ç–µ –ø–µ–Ω—É –Ω–∞ –ª–∞–¥–æ–Ω—å.\n"
            "3. –ê–∫–∫—É—Ä–∞—Ç–Ω–æ –Ω–∞–Ω–µ—Å–∏—Ç–µ –Ω–∞ –∏–Ω—Ç–∏–º–Ω—É—é –∑–æ–Ω—É.\n"
            "4. –°–º–æ–π—Ç–µ —Ç—ë–ø–ª–æ–π –≤–æ–¥–æ–π.\n"
            "5. –ü—Ä–æ–º–æ–∫–Ω–∏—Ç–µ –∫–æ–∂—É –ø–æ–ª–æ—Ç–µ–Ω—Ü–µ–º.\n\n"
        
            "*–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–∫–∞–∑–∞–Ω–∏—è:*\n"
            "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –Ω–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å. –ü—Ä–∏ —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–∏ –ø—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ.\n\n"
        
            "*–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:*\n"
            "–¢–æ–ª—å–∫–æ –¥–ª—è –Ω–∞—Ä—É–∂–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è. –ò–∑–±–µ–≥–∞—Ç—å –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –≥–ª–∞–∑–∞.\n\n"
        
            "*–§–æ—Ä–º–∞ –≤—ã–ø—É—Å–∫–∞:*\n"
            "–§–ª–∞–∫–æ–Ω 30 –º–ª —Å –ø–æ–º–ø–æ–π. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏.\n\n"
        
            "*–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:*\n"
            "–ò–ü ‚ÄúDarAi Trade‚Äù, –ò–ò–ù 900520401139\n"
            "—É–ª. –ê–∫–∞—Ç–∞–µ–≤–∞ 75/2, –≥. –ê–ª–º–∞—Ç—ã, –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω\n"
            "Email: info@daraitrade.com\n\n"
        
            "–ù–∞–ø–∏—à–∏—Ç–µ *–º–µ–Ω—é*, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥."
        )

                        
    else:
        msg.body("‚ùó –í–≤–µ–¥–∏—Ç–µ 1 —á—Ç–æ–±—ã –∑–∞–∫–∞–∑–∞—Ç—å –∏–ª–∏ 2 —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ.")
        user_state[from_number] = state
        return str(resp)

    if state["step"] == "ask_quantity":
        if user_msg.isdigit():
            quantity = int(user_msg)
            price = quantity * 1800
            state.update({
                "quantity": quantity,
                "price": price,
                "step": "ask_name"
            })
            msg.body(f"–•–æ—Ä–æ—à–æ, {quantity} —à—Ç—É–∫ –±—É–¥–µ—Ç —Å—Ç–æ–∏—Ç—å {price}‚Ç∏.\n\n2Ô∏è‚É£ –£–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à–µ –∏–º—è:")
        else:
            msg.body("‚ùó –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.")
        user_state[from_number] = state
        return str(resp)

    if state["step"] == "ask_name":
        name = user_msg.strip().title()
        state.update({
            "name": name,
            "step": "ask_address"
        })
        msg.body(f"–°–ø–∞—Å–∏–±–æ, {name}!\n\n3Ô∏è‚É£ –£–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:")
        user_state[from_number] = state
        return str(resp)

    if state["step"] == "ask_address":
        address = user_msg.strip()
        state.update({
            "address": address,
            "step": "ask_phone"
        })
        msg.body("4Ô∏è‚É£ –£–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:")
        user_state[from_number] = state
        return str(resp)

    if state["step"] == "ask_phone":
        phone = user_msg.strip()
        name = state["name"]
        quantity = state["quantity"]
        price = state["price"]
        address = state["address"]

        # Insert into DB and return the order ID
        cursor.execute(
            "INSERT INTO orders (name, quantity, price, address, phone) VALUES (%s, %s, %s, %s, %s) RETURNING id",
            (name, quantity, price, address, phone)
        )
        order_id = cursor.fetchone()[0]
        conn.commit()

        msg.body(
            f"‚úÖ –í—Å—ë –≥–æ—Ç–æ–≤–æ! –í–∞—à –∑–∞–∫–∞–∑ ‚Ññ{order_id} –ø—Ä–∏–Ω—è—Ç:\n\n"
            f"–ò–º—è: {name}\n"
            f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {quantity}\n"
            f"–°—É–º–º–∞: {price}‚Ç∏\n"
            f"–ê–¥—Ä–µ—Å: {address}\n"
            f"–¢–µ–ª–µ—Ñ–æ–Ω: {phone}\n\n"
            f"–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–∫–∞–∑! üíö\n"
            f"–ù–∞–ø–∏—à–∏—Ç–µ '–º–µ–Ω—é' —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞"
        )

        user_state.pop(from_number)
        return str(resp)

    # Fallback if input unrecognized
    msg.body("üòï –Ø –≤–∞—Å –Ω–µ –ø–æ–Ω—è–ª. –ù–∞–ø–∏—à–∏—Ç–µ '–º–µ–Ω—é' —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞.")
    return str(resp)

# ‚úÖ Start server
if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)


